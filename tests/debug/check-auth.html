<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Auth Check - FixItMati</title>
  <style>
    body {
      font-family: system-ui;
      max-width: 800px;
      margin: 50px auto;
      padding: 20px;
    }
    .status {
      padding: 15px;
      margin: 10px 0;
      border-radius: 5px;
      border: 1px solid;
    }
    .success {
      background: #d4edda;
      border-color: #c3e6cb;
      color: #155724;
    }
    .error {
      background: #f8d7da;
      border-color: #f5c6cb;
      color: #721c24;
    }
    .info {
      background: #d1ecf1;
      border-color: #bee5eb;
      color: #0c5460;
    }
    button {
      background: #007bff;
      color: white;
      border: none;
      padding: 10px 20px;
      border-radius: 5px;
      cursor: pointer;
      margin: 5px;
    }
    button:hover {
      background: #0056b3;
    }
    pre {
      background: #f5f5f5;
      padding: 10px;
      border-radius: 5px;
      overflow-x: auto;
    }
  </style>
</head>
<body>
  <h1>üîç Authentication Diagnostic Tool</h1>
  
  <div id="status"></div>
  
  <h2>Actions</h2>
  <button onclick="checkAuth()">üîÑ Refresh Check</button>
  <button onclick="testAPI()">üß™ Test API</button>
  <button onclick="goToLogin()">üîë Go to Login</button>
  <button onclick="clearAuth()">üóëÔ∏è Clear Auth</button>
  
  <h2>Details</h2>
  <div id="details"></div>
  
  <script>
    function checkAuth() {
      const statusDiv = document.getElementById('status');
      const detailsDiv = document.getElementById('details');
      
      const token = localStorage.getItem('auth_token');
      const userData = localStorage.getItem('user');
      
      let html = '<h3>Status:</h3>';
      let detailsHtml = '';
      
      if (!token) {
        html += '<div class="status error">‚ùå Not Logged In - No auth_token found</div>';
        detailsHtml += '<p><strong>Issue:</strong> No authentication token in localStorage</p>';
        detailsHtml += '<p><strong>Solution:</strong> Please log in first</p>';
      } else {
        html += '<div class="status success">‚úÖ Auth Token Found</div>';
        detailsHtml += '<p><strong>Token:</strong></p><pre>' + token.substring(0, 50) + '...</pre>';
      }
      
      if (!userData) {
        html += '<div class="status error">‚ùå No User Data</div>';
      } else {
        try {
          const user = JSON.parse(userData);
          html += '<div class="status success">‚úÖ User Data Found</div>';
          detailsHtml += '<p><strong>User:</strong></p><pre>' + JSON.stringify(user, null, 2) + '</pre>';
          
          if (user.role === 'admin' || user.role === 'staff') {
            html += '<div class="status success">‚úÖ Admin/Staff Role Confirmed</div>';
          } else {
            html += '<div class="status error">‚ùå Not Admin/Staff (Role: ' + user.role + ')</div>';
          }
        } catch (e) {
          html += '<div class="status error">‚ùå Invalid User Data: ' + e.message + '</div>';
        }
      }
      
      statusDiv.innerHTML = html;
      detailsDiv.innerHTML = detailsHtml;
    }
    
    async function testAPI() {
      const detailsDiv = document.getElementById('details');
      detailsDiv.innerHTML = '<div class="status info">Testing API...</div>';
      
      const token = localStorage.getItem('auth_token');
      
      try {
        const response = await fetch('/api/requests', {
          headers: {
            'Content-Type': 'application/json',
            'Authorization': 'Bearer ' + token
          }
        });
        
        const data = await response.json();
        
        let html = '<h3>API Test Result:</h3>';
        html += '<p><strong>Status:</strong> ' + response.status + ' ' + response.statusText + '</p>';
        
        if (response.ok) {
          html += '<div class="status success">‚úÖ API Working</div>';
          html += '<pre>' + JSON.stringify(data, null, 2) + '</pre>';
        } else {
          html += '<div class="status error">‚ùå API Error</div>';
          html += '<pre>' + JSON.stringify(data, null, 2) + '</pre>';
        }
        
        detailsDiv.innerHTML = html;
      } catch (error) {
        detailsDiv.innerHTML = '<div class="status error">‚ùå Request Failed: ' + error.message + '</div>';
      }
    }
    
    function goToLogin() {
      window.location.href = '/login.php';
    }
    
    function clearAuth() {
      if (confirm('Clear all authentication data?')) {
        localStorage.removeItem('auth_token');
        localStorage.removeItem('user');
        checkAuth();
      }
    }
    
    // Run check on load
    checkAuth();
  </script>
</body>
</html>
