# Database Table Explanation: Payments vs Transactions

## Overview
There are two separate tables for managing billing and payments, each serving a distinct purpose in the billing workflow.

---

## ðŸ“‹ PAYMENTS Table
**Purpose:** Stores BILLS/INVOICES (what users OWE)

### What it represents:
- Monthly bills generated by admin (Water Bill, Electric Bill)
- Bills that users need to pay
- Invoices with due dates

### Key Fields:
```
- id: Unique payment/bill ID
- user_id: Who owes this bill
- bill_month: Which month ("October 2024", "December 2025")
- amount: How much is owed
- status: unpaid | paid | overdue
- due_date: When payment is due
- paid_date: When it was actually paid (NULL if unpaid)
- payment_method: How it was paid (NULL until paid)
```

### Status Values:
- `unpaid` - Bill not yet paid
- `paid` - Bill fully paid
- `overdue` - Past due date and still unpaid

### Example:
```
Bill ID: cd54f301-1e7f-470c-8fb1-f9b9c4e484d3
User: John Doe
Bill Month: October 2024
Amount: â‚±1,675.00
Status: paid
Due Date: 2024-10-25
```

---

## ðŸ’³ TRANSACTIONS Table
**Purpose:** Stores PAYMENT SUBMISSIONS (user payment attempts)

### What it represents:
- When a user submits a payment
- Payment proof uploads
- Admin approval/rejection of payments
- Transaction history

### Key Fields:
```
- id: Unique transaction ID
- user_id: Who made the payment
- payment_id: Which bill this pays for (can be NULL)
- amount: How much user paid
- type: payment | refund
- status: pending | completed | failed
- reference_number: Transaction reference (TRX-XXXXX)
- notes: Admin notes or rejection reason
```

### Status Values:
- `pending` - Waiting for admin approval
- `completed` - Approved by admin
- `failed` - Rejected by admin

### Example:
```
Transaction ID: 2c8d4c4e-f3b7-4934-a74b-98e3bb06ef7b
Payment ID: cd54f301-1e7f-470c-8fb1-f9b9c4e484d3 (links to bill above)
Amount: â‚±1,675.00
Type: payment
Status: completed
Reference: TRX-F1FB1EF1
```

---

## ðŸ”„ Workflow Relationship

### Step 1: Admin Creates Invoice
```sql
INSERT INTO payments (user_id, bill_month, amount, status, due_date)
VALUES ('user-123', 'December 2025', 500.00, 'unpaid', '2025-12-31')
```
**Result:** User has a bill to pay

---

### Step 2: User Submits Payment
```sql
INSERT INTO transactions (user_id, payment_id, amount, type, status, reference_number)
VALUES ('user-123', 'payment-456', 500.00, 'payment', 'pending', 'TRX-ABC123')
```
**Result:** Payment submission waiting for admin approval

---

### Step 3: Admin Approves Transaction
```sql
-- Update transaction
UPDATE transactions SET status = 'completed' WHERE id = 'transaction-789';

-- Update payment
UPDATE payments 
SET status = 'paid', paid_date = NOW(), payment_method = 'gcash'
WHERE id = 'payment-456';
```
**Result:** Bill marked as paid, transaction approved

---

## ðŸŽ¯ What billing.php Should Use

### For ADMIN DASHBOARD (billing.php):

#### Display Recent Transactions (What to Approve/Reject):
```sql
SELECT * FROM transactions 
WHERE status = 'pending'
ORDER BY created_at DESC
```
**Use Case:** Show payment submissions needing approval

#### Display Revenue & Stats:
```sql
-- Total revenue from paid bills
SELECT SUM(amount) FROM payments WHERE status = 'paid'

-- Pending transactions count
SELECT COUNT(*) FROM transactions WHERE status = 'pending'
```

#### Create Invoice Action:
```sql
INSERT INTO payments (user_id, bill_month, amount, status, due_date)
VALUES (...)
```
**Creates a new bill for the user**

#### Approve Transaction Action:
```sql
-- 1. Mark transaction as completed
UPDATE transactions SET status = 'completed' WHERE id = ?

-- 2. Mark bill as paid
UPDATE payments 
SET status = 'paid', paid_date = NOW()
WHERE id = (SELECT payment_id FROM transactions WHERE id = ?)
```

#### Reject Transaction Action:
```sql
UPDATE transactions 
SET status = 'failed', notes = 'Rejection reason'
WHERE id = ?
```
**Bill remains unpaid, user can resubmit**

---

## ðŸ“Š Current billing.php Implementation

Your current code correctly uses:

### 1. **Loading Transactions** (Line 112 in billing-admin.js):
```javascript
fetch('/api/admin/transactions')  // Gets transactions for approval
```
âœ… **CORRECT** - Shows payment submissions to approve/reject

### 2. **Loading Stats** (Line 160):
```javascript
fetch('/api/admin/billing/stats')  // Revenue from payments table
```
âœ… **CORRECT** - Revenue calculated from payments (bills)

### 3. **Create Invoice** (Line 403):
```javascript
fetch('/api/admin/billing/create-invoice')  // Creates payment record
```
âœ… **CORRECT** - Creates new bill in payments table

### 4. **Approve/Reject** (Line 559):
```javascript
fetch(`/api/admin/transactions/${id}/approve`)  // Approve transaction
```
âœ… **CORRECT** - Approves transaction AND updates payment

---

## ðŸ’¡ Summary

| Aspect | PAYMENTS Table | TRANSACTIONS Table |
|--------|---------------|-------------------|
| **What** | Bills/Invoices | Payment Submissions |
| **Created By** | Admin | User |
| **Purpose** | Track what users owe | Track payment attempts |
| **Status Flow** | unpaid â†’ paid/overdue | pending â†’ completed/failed |
| **Admin Action** | Create invoices | Approve/reject payments |
| **Display In** | Billing history | Recent transactions (approval queue) |

### Key Insight:
- **One PAYMENT** (bill) can have **multiple TRANSACTIONS** (if user submits payment multiple times)
- **One TRANSACTION** links to **one PAYMENT** via `payment_id` foreign key
- When admin approves a transaction, the linked payment is marked as paid

---

## âœ… Recommendation

**Your current billing.php implementation is CORRECT!**

It properly uses:
- `transactions` table for showing payment submissions to approve/reject
- `payments` table for creating invoices and calculating revenue
- The relationship between both tables when approving payments

**No changes needed** - the architecture is sound and follows proper billing workflow patterns.
